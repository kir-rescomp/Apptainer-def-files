Bootstrap: docker
From: nvidia/cuda:12.6.3-base-ubuntu24.04

%environment
    export UV_COMPILE_BYTECODE=1
    export UV_PROJECT_ENVIRONMENT=/alphafold3_venv
    export PATH="/hmmer/bin:/alphafold3_venv/bin:/app/alphafold:$PATH"
    export XLA_FLAGS="--xla_gpu_enable_triton_gemm=false"
    export XLA_PYTHON_CLIENT_PREALLOCATE=true
    export XLA_CLIENT_MEM_FRACTION=0.95

%post
    # Update and install basic dependencies
    DEBIAN_FRONTEND=noninteractive apt-get update --quiet
    DEBIAN_FRONTEND=noninteractive apt-get install --yes --quiet \
        python3.12 python3.12-dev \
        git wget gcc g++ make zlib1g-dev zstd

    # Install uv (version pinned for reproducibility)
    wget -O - https://astral.sh/uv/0.9.24/install.sh | UV_INSTALL_DIR="/bin" sh

    # Set up the virtual environment
    UV_COMPILE_BYTECODE=1
    UV_PROJECT_ENVIRONMENT=/alphafold3_venv
    uv venv $UV_PROJECT_ENVIRONMENT

    # Install HMMER from source with the --seq_limit patch applied
    mkdir /hmmer_build /hmmer
    wget http://eddylab.org/software/hmmer/hmmer-3.4.tar.gz --directory-prefix /hmmer_build
    cd /hmmer_build && echo "ca70d94fd0cf271bd7063423aabb116d42de533117343a9b27a65c17ff06fbf3 hmmer-3.4.tar.gz" | sha256sum --check
    cd /hmmer_build && tar zxf hmmer-3.4.tar.gz && rm hmmer-3.4.tar.gz

    # Apply the --seq_limit patch to HMMER
    wget --directory-prefix /hmmer_build \
        https://raw.githubusercontent.com/google-deepmind/alphafold3/751a4b8612d0d53de8f6e1830c8f726e873a55cf/docker/jackhmmer_seq_limit.patch
    cd /hmmer_build && patch -p0 < jackhmmer_seq_limit.patch

    cd /hmmer_build/hmmer-3.4 && ./configure --prefix /hmmer
    cd /hmmer_build/hmmer-3.4 && make -j8
    cd /hmmer_build/hmmer-3.4 && make install
    cd /hmmer_build/hmmer-3.4/easel && make install
    cd / && rm -R /hmmer_build 

    # Clone AlphaFold 3 source
    mkdir -p /app/alphafold
    git clone https://github.com/google-deepmind/alphafold3.git /app/alphafold
    cd /app/alphafold

    export PATH="/hmmer/bin:/alphafold3_venv/bin:$PATH"
    export UV_PROJECT_ENVIRONMENT=/alphafold3_venv

    # Install the exact dependency tree using uv
    # --frozen: do not update the lockfile during build
    # --all-groups: install development/test dependencies defined in pyproject.toml
    # --no-editable: install as a static package
    UV_LINK_MODE=copy uv sync --frozen --all-groups --no-editable

    # Build chemical components database (binary installed by uv sync)
    uv run build_data

    # Cleanup
    uv cache prune
    apt-get clean

%runscript
    cd /app/alphafold
    UV_NO_CACHE=1 uv run --no-project python3 run_alphafold.py "$@"

%labels
    Author DeepMind Technologies Limited
    Version AlphaFold 3
    License CC BY-NC-SA 4.0
